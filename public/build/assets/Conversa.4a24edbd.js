import{B as N,$ as d,k as I,G as D,l as F,Y as x,z as g,a as O,w as V,o as u,b as i,t as z,u as l,g as f,i as H,r as P,H as W,F as j,e as G,E as Y,j as $,d as J,v as K}from"./app.f4baed2d.js";import{S as Q}from"./SiteLayout.691db9e3.js";import{E as R,L as X}from"./_plugin-vue_export-helper.2a9e5e66.js";const Z={class:"container conversa"},ee={class:"conteudo"},ne={class:"container-mensagens"},se={key:0,class:"loader-inline"},ae=i("span",{class:"elemento"},null,-1),te=[ae],ie=["id"],oe=i("span",null,"Novas Mensagens",-1),le=[oe],re=["onSubmit"],ce={class:"col"},ue=i("button",{type:"submit",class:"btn btn-primary"},"Enviar",-1),me={class:"textcount"},ve=N({__name:"Conversa",props:["conversa","usuario_id"],setup(v){const c=v;let p=d.exports.debounce(L,100,{maxWait:250});d.exports.debounce(M,500,{maxWait:1e4});const h=25,T=2500;let r=c.conversa.visualizacao.ultima_mensagem_id;const t=I(null);let s=D({mensagens:c.conversa.mensagens,mensagem:"",mensagensAnteriores:!1,novasMensagens:!1});R.addListener(new X(U,1)),F(()=>{t.value.scrollHeight>t.value.clientHeight+h&&(s.mensagensAnteriores=!0),x(b)});function k(){return g.post(route("site.conversa.enviar",c.conversa.id),{mensagem:s.mensagem}).then(()=>{s.mensagem=""}).catch(e=>{location.reload()})}function C(){return s.mensagens.findLast(e=>e.id<=r)}function b(){var n,a;let e=C();e&&m(_(e.id)-t.value.clientHeight/2),t.value.scrollTop<((n=t.value.querySelector(".loader-inline"))==null?void 0:n.clientHeight)&&m((a=t.value.querySelector(".loader-inline"))==null?void 0:a.clientHeight),x(y)}function E(){s.novasMensagens=!1;let e=q();e?(m(_(e.id)-t.value.clientHeight/2),r=e.id,M()):b()}function q(){return s.mensagens.find(e=>e.id>r)}function m(e){t.value.scrollTop=e,setTimeout(()=>{p.cancel()},100)}function _(e){return t.value.querySelector("#msg-"+e).offsetTop-t.value.offsetTop}function L(e){t.value.scrollTop<=h&&B(),y(),t.value.scrollTop+t.value.clientHeight>=t.value.scrollHeight-h&&(s.novasMensagens=!1)}function y(){let e=w();e&&e.id>r&&(r=e.id,M())}function w(){let e=s.mensagens.findIndex(n=>n.id>r);return s.mensagens.slice(e).findLast(n=>A(n.id))}function A(e){let n=t.value.querySelector("#msg-"+e),a=n.offsetTop+n.clientHeight-n.parentElement.offsetTop;return a>n.parentElement.scrollTop&&a<n.parentElement.scrollTop+n.parentElement.clientHeight}function M(){g.post(route("site.conversa.mensagens.visualizacao",[c.conversa.id,r]))}function o(){function e(){var n,a;return g.get(route("site.conversa.mensagens",[c.conversa.id,(a=(n=d.exports.last(s.mensagens))==null?void 0:n.id)!=null?a:0])).then(S=>{S.data.mensagens.length>0&&(s.mensagens=s.mensagens.concat(S.data.mensagens),s.novasMensagens=!0)})}if(o.bloquear){o.atualizar=!0;return}o.bloquear=!0,o.atualizar=!1,e().finally(()=>{o.bloquear=!1,o.atualizar&&o()})}function U(e){var n,a;e.mensagem_id>((a=(n=d.exports.last(s.mensagens))==null?void 0:n.id)!=null?a:0)&&o()}function B(){if(!s.mensagensAnteriores||s.mensagens>0)return;let e=s.mensagens[0].id;g.get(route("site.conversa.mensagens.anteriores",[c.conversa.id,e])).then(n=>{s.mensagens=n.data.mensagens.concat(s.mensagens),s.mensagensAnteriores=n.data.mais,x(()=>{m(_(e))})})}return(e,n)=>(u(),O(Q,null,{default:V(()=>[i("div",Z,[i("h2",null,"Conversa - "+z(v.conversa.equipamento.titulo),1),i("div",ee,[i("div",ne,[i("div",{class:"mensagens",onScroll:n[0]||(n[0]=(...a)=>l(p)&&l(p)(...a)),ref_key:"elMensagens",ref:t},[l(s).mensagensAnteriores?(u(),f("div",se,te)):H("",!0),(u(!0),f(j,null,P(l(s).mensagens,a=>(u(),f("span",{class:W(["mensagem",{autor:a.usuario_id==v.usuario_id}]),id:"msg-"+a.id,key:a.id},z(a.mensagem),11,ie))),128))],544),G(Y,{name:"fade-transition",duration:100},{default:V(()=>[l(s).novasMensagens?(u(),f("button",{key:0,class:"novas-mensagens",onClick:E},le)):H("",!0)]),_:1})]),i("form",{onSubmit:$(k,["prevent"]),class:"mensagens-footer"},[J(i("textarea",{class:"form-control","onUpdate:modelValue":n[1]||(n[1]=a=>l(s).mensagem=a),maxlength:T,rows:"3"},null,512),[[K,l(s).mensagem]]),i("div",ce,[ue,i("span",me,z(l(s).mensagem.length+" / "+T),1)])],40,re)])])]),_:1}))}});export{ve as default};
