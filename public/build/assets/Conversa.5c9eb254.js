import{d as B,$ as m,m as N,H as $,n as O,Z as M,B as d,a as D,w as V,o as c,b as o,t as x,u as H,i as g,k as S,r as F,I as P,F as W,g as j,T as Z,l as G,e as J,f as K}from"./app.e1a1d14f.js";import{E as Q,L as R}from"./_plugin-vue_export-helper.f4461edf.js";import{_ as X}from"./SiteLayout.vue_vue_type_script_setup_true_lang.c5ef1dfc.js";const Y={class:"container conversa"},ee={class:"conteudo"},ne={class:"container-mensagens"},se={key:0,class:"loader-inline"},ae=o("span",{class:"elemento"},null,-1),te=[ae],oe=["id"],ie=o("span",null,"Novas Mensagens",-1),re=[ie],le=["onSubmit"],ce={class:"col"},ue=o("button",{type:"submit",class:"btn btn-primary"}," Enviar ",-1),me={class:"textcount"},ve=B({__name:"Conversa",props:{conversa:Object,usuarioId:Number},setup(f){const l=f,v=m.exports.debounce(A,100,{maxWait:250});m.exports.debounce(_,500,{maxWait:1e4});const p=25,z=2500;let r=l.conversa.visualizacao.ultima_mensagem_id;const t=N(null),s=$({mensagens:l.conversa.mensagens,mensagem:"",mensagensAnteriores:!1,novasMensagens:!1});Q.addListener(new R(L,1)),O(()=>{t.value.scrollHeight>t.value.clientHeight+p&&(s.mensagensAnteriores=!0),M(b)});function k(){return d.post(route("site.conversa.enviar",l.conversa.id),{mensagem:s.mensagem}).then(()=>{s.mensagem=""}).catch(e=>{location.reload()})}function q(){return s.mensagens.findLast(e=>e.id<=r)}function b(){var n,a;const e=q();e&&u(h(e.id)-t.value.clientHeight/2),t.value.scrollTop<((n=t.value.querySelector(".loader-inline"))==null?void 0:n.clientHeight)&&u((a=t.value.querySelector(".loader-inline"))==null?void 0:a.clientHeight),M(T)}function C(){s.novasMensagens=!1;const e=E();e?(u(h(e.id)-t.value.clientHeight/2),r=e.id,_()):b()}function E(){return s.mensagens.find(e=>e.id>r)}function u(e){t.value.scrollTop=e,setTimeout(()=>{v.cancel()},100)}function h(e){return t.value.querySelector(`#msg-${e}`).offsetTop-t.value.offsetTop}function A(e){t.value.scrollTop<=p&&U(),T(),t.value.scrollTop+t.value.clientHeight>=t.value.scrollHeight-p&&(s.novasMensagens=!1)}function T(){const e=w();e&&e.id>r&&(r=e.id,_())}function w(){const e=s.mensagens.findIndex(n=>n.id>r);return s.mensagens.slice(e).findLast(n=>I(n.id))}function I(e){const n=t.value.querySelector(`#msg-${e}`),a=n.offsetTop+n.clientHeight-n.parentElement.offsetTop;return a>n.parentElement.scrollTop&&a<n.parentElement.scrollTop+n.parentElement.clientHeight}function _(){d.post(route("site.conversa.mensagens.visualizacao",[l.conversa.id,r]))}function i(){function e(){var n,a;return d.get(route("site.conversa.mensagens",[l.conversa.id,(a=(n=m.exports.last(s.mensagens))==null?void 0:n.id)!=null?a:0])).then(y=>{y.data.mensagens.length>0&&(s.mensagens=s.mensagens.concat(y.data.mensagens),s.novasMensagens=!0)})}if(i.bloquear){i.atualizar=!0;return}i.bloquear=!0,i.atualizar=!1,e().finally(()=>{i.bloquear=!1,i.atualizar&&i()})}function L(e){var n,a;e.mensagem_id>((a=(n=m.exports.last(s.mensagens))==null?void 0:n.id)!=null?a:0)&&i()}function U(){if(!s.mensagensAnteriores||s.mensagens>0)return;const e=s.mensagens[0].id;d.get(route("site.conversa.mensagens.anteriores",[l.conversa.id,e])).then(n=>{s.mensagens=n.data.mensagens.concat(s.mensagens),s.mensagensAnteriores=n.data.mais,M(()=>{u(h(e))})})}return(e,n)=>(c(),D(X,null,{default:V(()=>[o("div",Y,[o("h2",null,"Conversa - "+x(f.conversa.equipamento.titulo),1),o("div",ee,[o("div",ne,[o("div",{ref_key:"elMensagens",ref:t,class:"mensagens",onScroll:n[0]||(n[0]=(...a)=>H(v)&&H(v)(...a))},[s.mensagensAnteriores?(c(),g("div",se,te)):S("",!0),(c(!0),g(W,null,F(s.mensagens,a=>(c(),g("span",{id:"msg-"+a.id,key:a.id,class:P(["mensagem",{autor:a.usuario_id==f.usuarioId}])},x(a.mensagem),11,oe))),128))],544),j(Z,{name:"fade-transition",duration:100},{default:V(()=>[s.novasMensagens?(c(),g("button",{key:0,type:"button",class:"novas-mensagens",onClick:C},re)):S("",!0)]),_:1})]),o("form",{class:"mensagens-footer",onSubmit:G(k,["prevent"])},[J(o("textarea",{"onUpdate:modelValue":n[1]||(n[1]=a=>s.mensagem=a),class:"form-control",maxlength:z,rows:"3"},null,512),[[K,s.mensagem]]),o("div",ce,[ue,o("span",me,x(s.mensagem.length+" / "+z),1)])],40,le)])])]),_:1}))}});export{ve as default};
