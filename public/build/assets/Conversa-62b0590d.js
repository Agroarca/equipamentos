import{d as te,a5 as l,r as d,i as ie,x as oe,Z as z,j as g,c as C,w as H,o as u,a as i,t as j,k as M,h as L,l as I,u as b,m as re,F as le,f as U,T as ue,g as ce,b as me,e as de}from"./app-78c8b63e.js";import{_ as ge}from"./SiteLayout.vue_vue_type_script_setup_true_lang-0fbfbf70.js";import{_ as fe}from"./Mensagem.vue_vue_type_script_setup_true_lang-9e382fac.js";import{g as f,E as ve,L as pe}from"./_plugin-vue_export-helper-39dc433b.js";import{_ as Me}from"./FormError.vue_vue_type_script_setup_true_lang-0f1744f4.js";import"./Modal.vue_vue_type_script_setup_true_lang-a42be9d2.js";import"./index-ac617c56.js";const _e={class:"container conversa"},he=i("br",null,null,-1),xe={class:"conteudo"},ze={class:"container-mensagens"},Ie={key:0,class:"loader-inline"},be=i("span",{class:"elemento"},null,-1),ye=[be],Ae=i("span",null,"Novas Mensagens",-1),Te=[Ae],Ve=["onSubmit"],Ee={class:"col"},qe={class:"row"},we={class:"d-flex flex-row"},$e={class:"col"},Ne=i("button",{type:"submit",class:"btn btn-primary"}," Enviar ",-1),Pe={class:"textcount"},Be=te({__name:"Conversa",props:{conversa:Object,usuarioId:Number,mensagensTempoExcluir:Number},setup(c){const v=c,_=l.debounce(O,100,{maxWait:250}),h=25,y=2500,n=d(null);let m=d(""),A=-1,r={bloquearAtualizar:!1,atualizar:!1,bloquearAtualizarAnteriores:!1};const a=ie({mensagens:v.conversa.mensagens,mensagensAnteriores:d(!1),novasMensagens:d(!1),temPermNotificacao:d(f().temPermissao()),conversaId:v.conversa.id,ultimaMsgVisualizadaId:v.conversa.visualizacao.ultima_mensagem_id,usuarioId:v.usuarioId,textoMsg:""});oe(()=>{n.value.scrollHeight>n.value.clientHeight+h&&(a.mensagensAnteriores=!0),z(T),se()});async function B(){var e,s,o,$,N,P,S,k;try{let t={id:A,mensagem:a.textoMsg,usuario_id:a.usuarioId,created_at:new Date,loading:!0};A-=1,a.textoMsg="",a.mensagens.push(t),await Y(t.mensagem),a.mensagens=l.filter(a.mensagens,ne=>ne.id!==t.id),Q()}catch(t){if((o=(s=(e=t==null?void 0:t.response)==null?void 0:e.data)==null?void 0:s.errors)!=null&&o.mensagem){if(Array.isArray((P=(N=($=t==null?void 0:t.response)==null?void 0:$.data)==null?void 0:N.errors)==null?void 0:P.mensagem)){[m.value]=t.response.data.errors.mensagem;return}m.value=t.response.data.errors.mensagem;return}if((k=(S=t==null?void 0:t.response)==null?void 0:S.data)!=null&&k.message){m.value=t.response.data.message;return}m.value="Erro ao enviar mensagem",setTimeout(()=>{location.reload()},5e3)}}function T(){var s,o;const e=G();e&&p(x(e.id)-n.value.clientHeight/2),n.value.scrollTop<((s=n.value.querySelector(".loader-inline"))==null?void 0:s.clientHeight)&&p((o=n.value.querySelector(".loader-inline"))==null?void 0:o.clientHeight),z(V)}function D(){a.novasMensagens=!1;const e=J(a.ultimaMsgVisualizadaId);e?(p(x(e.id)-n.value.clientHeight/2),E(e.id)):T()}function p(e){n.value.scrollTop=e,setTimeout(()=>{_.cancel()},100)}function x(e){return n.value.querySelector(`#msg-${e}`).offsetTop-n.value.offsetTop}function O(){n.value.scrollTop<=h&&K(),V(),n.value.scrollTop+n.value.clientHeight>=n.value.scrollHeight-h&&(a.novasMensagens=!1)}function V(){const e=F();e&&e.id>a.ultimaMsgVisualizadaId&&(a.ultimaMsgVisualizadaId=e.id,E(a.ultimaMsgVisualizadaId))}function F(){const e=a.mensagens.findIndex(s=>s.id>a.ultimaMsgVisualizadaId);return a.mensagens.slice(e).findLast(s=>W(s.id))}function W(e){const s=n.value.querySelector(`#msg-${e}`),o=s.offsetTop+s.clientHeight-s.parentElement.offsetTop;return o>s.parentElement.scrollTop&&o<s.parentElement.scrollTop+s.parentElement.clientHeight}function Z(e){ae(e.id)}function G(){return a.mensagens.findLast(e=>e.id<=a.ultimaMsgVisualizadaId)}function J(e){return a.mensagens.find(s=>s.id>e)}function E(e){e<a.ultimaMsgVisualizadaId||(a.ultimaMsgVisualizadaId=e,ee(e))}async function q(){var e;r.bloquearAtualizar&&(r.atualizar=!0),r.bloquearAtualizar=!0,r.atualizar=!1,await X(((e=l.last(a.mensagens))==null?void 0:e.id)??0),r.bloquearAtualizar=!1,r.atualizar&&q()}async function K(){if(!a.mensagensAnteriores.value||a.mensagens.length===0||r.bloquearAtualizarAnteriores)return;r.bloquearAtualizarAnteriores=!0;const e=l.first(a.mensagens).id;await R(e),z(()=>{p(x(e))}),r.bloquearAtualizarAnteriores=!1}function w(){f().solicitarPermissao().then(()=>{a.temPermNotificacao.value=f().temPermissao()})}function Q(){f().jaSolicitouPermissao()||f().temPermissao()||w()}async function R(e){let s=await g.get(`/conversa/${a.conversaId}/mensagens/anteriores/${e}`);a.mensagens=s.data.mensagens.concat(a.mensagens),a.mensagensAnteriores.value=s.data.mais}async function X(e){let s=await g.get(`/conversa/${a.conversaId}/mensagens/posteriores/${e}`);s.data.mensagens.length>0&&(a.mensagens=a.mensagens.concat(s.data.mensagens),a.novasMensagens.value=!0)}async function Y(e){let s=await g.post(`/conversa/${a.conversaId}/enviar`,{mensagem:e});a.mensagens.push(s.data)}function ee(e){g.post(`/conversa/${a.conversaId}/mensagens/visualizacao/${e}`)}function ae(e){g.get(`/conversa/${a.conversaId}/mensagem/excluir/${e}`).then(()=>{a.mensagens=l.filter(a.mensagens,s=>e!==s.id)})}function se(){ve.addListener(new pe(e=>{var s;e.mensagem_id>(((s=l.last(a.mensagens))==null?void 0:s.id)??0)&&q()},1))}return(e,s)=>(u(),C(ge,{titulo:`Conversa ${c.conversa.equipamento.titulo}`},{default:H(()=>[i("div",_e,[i("h2",null,"Conversa - "+j(c.conversa.equipamento.titulo),1),a.temPermNotificacao?I("",!0):(u(),M("div",{key:0,class:"alert alert-warning mt-2 mb-4 cursor-pointer",onClick:w},[L(" Você não irá receber notificações de novas mensagens."),he,L(" Clique aqui para autorizar as Notificações ")])),i("div",xe,[i("div",ze,[i("div",{ref_key:"elMensagens",ref:n,class:"mensagens",onScroll:s[0]||(s[0]=(...o)=>b(_)&&b(_)(...o))},[a.mensagensAnteriores?(u(),M("div",Ie,ye)):I("",!0),(u(!0),M(le,null,re(a.mensagens,o=>(u(),C(fe,{key:o.id,mensagem:o,usuarioId:c.usuarioId,mensagensTempoExcluir:c.mensagensTempoExcluir,onExcluirMensagem:Z},null,8,["mensagem","usuarioId","mensagensTempoExcluir"]))),128))],544),U(ue,{name:"fade-transition",duration:100},{default:H(()=>[a.novasMensagens?(u(),M("button",{key:0,type:"button",class:"novas-mensagens",onClick:D},Te)):I("",!0)]),_:1})]),i("form",{class:"mensagens-footer",onSubmit:ce(B,["prevent"])},[i("div",Ee,[i("div",qe,[U(Me,{error:b(m)},null,8,["error"])]),i("div",we,[me(i("textarea",{"onUpdate:modelValue":s[1]||(s[1]=o=>a.textoMsg=o),class:"form-control",maxlength:y,rows:"3"},null,512),[[de,a.textoMsg]]),i("div",$e,[Ne,i("span",Pe,j(a.textoMsg.length+" / "+y),1)])])])],40,Ve)])])]),_:1},8,["titulo"]))}});export{Be as default};
