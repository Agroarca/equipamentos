import{d as X,a6 as f,m as E,H as Y,n as ee,Z as y,A as v,a as N,w as I,o as m,b as o,t as L,u as h,i as x,s as U,k as $,r as se,F as ne,g as B,T as ae,l as te,e as oe,f as ie}from"./app.a0c878fb.js";import{g as p,E as re,L as le}from"./_plugin-vue_export-helper.b7638313.js";import{_ as ce}from"./SiteLayout.vue_vue_type_script_setup_true_lang.1d70a6cb.js";import{_ as me}from"./Mensagem.vue_vue_type_script_setup_true_lang.cb024ab8.js";import{_ as ue}from"./FormError.vue_vue_type_script_setup_true_lang.d684babb.js";import"./index.c57ba517.js";import"./Modal.vue_vue_type_script_setup_true_lang.66978b13.js";const de={class:"container conversa"},ge=o("br",null,null,-1),fe={class:"conteudo"},ve={class:"container-mensagens"},pe={key:0,class:"loader-inline"},_e=o("span",{class:"elemento"},null,-1),he=[_e],xe=o("span",null,"Novas Mensagens",-1),Me=[xe],be=["onSubmit"],Te={class:"col"},ze={class:"row"},Ee={class:"d-flex flex-row"},ye={class:"col"},$e=o("button",{type:"submit",class:"btn btn-primary"}," Enviar ",-1),Ve={class:"textcount"},we=X({__name:"Conversa",props:{conversa:Object,usuarioId:Number,mensagensTempoExcluir:Number},setup(u){const l=u,M=f.exports.debounce(W,100,{maxWait:250});f.exports.debounce(z,500,{maxWait:1e4});const b=25,V=2500;let r=l.conversa.visualizacao.ultima_mensagem_id;const t=E(null);let q=E(p().temPermissao()),c=E("");const n=Y({mensagens:l.conversa.mensagens,mensagem:"",mensagensAnteriores:!1,novasMensagens:!1});re.addListener(new le(J,1)),ee(()=>{t.value.scrollHeight>t.value.clientHeight+b&&(n.mensagensAnteriores=!0),y(S)});function F(){return v.post(`/conversa/${l.conversa.id}/enviar`,{mensagem:n.mensagem}).then(()=>{n.mensagem="",c.value="",R()}).catch(e=>{var s,a,d,g,C,H,P,w;if((d=(a=(s=e==null?void 0:e.response)==null?void 0:s.data)==null?void 0:a.errors)!=null&&d.mensagem){if(Array.isArray((H=(C=(g=e==null?void 0:e.response)==null?void 0:g.data)==null?void 0:C.errors)==null?void 0:H.mensagem)){[c.value]=e.response.data.errors.mensagem;return}c.value=e.response.data.errors.mensagem;return}if((w=(P=e==null?void 0:e.response)==null?void 0:P.data)!=null&&w.message){c.value=e.response.data.message;return}c.value="Erro ao enviar mensagem",setTimeout(()=>{location.reload()},5e3)})}function O(){return n.mensagens.findLast(e=>e.id<=r)}function S(){var s,a;const e=O();e&&_(T(e.id)-t.value.clientHeight/2),t.value.scrollTop<((s=t.value.querySelector(".loader-inline"))==null?void 0:s.clientHeight)&&_((a=t.value.querySelector(".loader-inline"))==null?void 0:a.clientHeight),y(k)}function j(){n.novasMensagens=!1;const e=D();e?(_(T(e.id)-t.value.clientHeight/2),r=e.id,z()):S()}function D(){return n.mensagens.find(e=>e.id>r)}function _(e){t.value.scrollTop=e,setTimeout(()=>{M.cancel()},100)}function T(e){return t.value.querySelector(`#msg-${e}`).offsetTop-t.value.offsetTop}function W(e){t.value.scrollTop<=b&&K(),k(),t.value.scrollTop+t.value.clientHeight>=t.value.scrollHeight-b&&(n.novasMensagens=!1)}function k(){const e=Z();e&&e.id>r&&(r=e.id,z())}function Z(){const e=n.mensagens.findIndex(s=>s.id>r);return n.mensagens.slice(e).findLast(s=>G(s.id))}function G(e){const s=t.value.querySelector(`#msg-${e}`),a=s.offsetTop+s.clientHeight-s.parentElement.offsetTop;return a>s.parentElement.scrollTop&&a<s.parentElement.scrollTop+s.parentElement.clientHeight}function z(){v.post(`/conversa/${l.conversa.id}/mensagens/visualizacao/${r}`)}function i(){function e(){var a,d;let s=(d=(a=f.exports.last(n.mensagens))==null?void 0:a.id)!=null?d:0;return v.get(`/conversa/${l.conversa.id}/mensagens/posteriores/${s}`).then(g=>{g.data.mensagens.length>0&&(n.mensagens=n.mensagens.concat(g.data.mensagens),n.novasMensagens=!0)})}if(i.bloquear){i.atualizar=!0;return}i.bloquear=!0,i.atualizar=!1,e().finally(()=>{i.bloquear=!1,i.atualizar&&i()})}function J(e){var s,a;e.mensagem_id>((a=(s=f.exports.last(n.mensagens))==null?void 0:s.id)!=null?a:0)&&i()}function K(){if(!n.mensagensAnteriores||n.mensagens>0)return;const e=n.mensagens[0].id;v.get(`/conversa/${l.conversa.id}/mensagens/anteriores/${e}`).then(s=>{n.mensagens=s.data.mensagens.concat(n.mensagens),n.mensagensAnteriores=s.data.mais,y(()=>{_(T(e))})})}function Q(e){v.get(`/conversa/${e.equipamento_conversa_id}/mensagem/excluir/${e.id}`).then(()=>{n.mensagens=f.exports.filter(n.mensagens,s=>e.id!==s.id)})}function A(){p().solicitarPermissao().then(()=>{q.value=p().temPermissao()})}function R(){p().jaSolicitouPermissao()||p().temPermissao()||A()}return(e,s)=>(m(),N(ce,{titulo:`Conversa ${u.conversa.equipamento.titulo}`},{default:I(()=>[o("div",de,[o("h2",null,"Conversa - "+L(u.conversa.equipamento.titulo),1),h(q)?$("",!0):(m(),x("div",{key:0,class:"alert alert-warning mt-2 mb-4 cursor-pointer",onClick:A},[U(" Voc\xEA n\xE3o ir\xE1 receber notifica\xE7\xF5es de novas mensagens."),ge,U(" Clique aqui para autorizar as Notifica\xE7\xF5es ")])),o("div",fe,[o("div",ve,[o("div",{ref_key:"elMensagens",ref:t,class:"mensagens",onScroll:s[0]||(s[0]=(...a)=>h(M)&&h(M)(...a))},[n.mensagensAnteriores?(m(),x("div",pe,he)):$("",!0),(m(!0),x(ne,null,se(n.mensagens,a=>(m(),N(me,{key:a.id,mensagem:a,"usuario-id":u.usuarioId,"mensagens-tempo-excluir":u.mensagensTempoExcluir,onExcluirMensagem:Q},null,8,["mensagem","usuario-id","mensagens-tempo-excluir"]))),128))],544),B(ae,{name:"fade-transition",duration:100},{default:I(()=>[n.novasMensagens?(m(),x("button",{key:0,type:"button",class:"novas-mensagens",onClick:j},Me)):$("",!0)]),_:1})]),o("form",{class:"mensagens-footer",onSubmit:te(F,["prevent"])},[o("div",Te,[o("div",ze,[B(ue,{error:h(c)},null,8,["error"])]),o("div",Ee,[oe(o("textarea",{"onUpdate:modelValue":s[1]||(s[1]=a=>n.mensagem=a),class:"form-control",maxlength:V,rows:"3"},null,512),[[ie,n.mensagem]]),o("div",ye,[$e,o("span",Ve,L(n.mensagem.length+" / "+V),1)])])])],40,be)])])]),_:1},8,["titulo"]))}});export{we as default};
