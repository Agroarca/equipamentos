import{d as Q,a4 as _,m as y,H as R,n as X,Z as E,A as h,a as Y,w as I,o as u,b as o,t as V,u as x,i as g,s as L,k as S,r as ee,I as se,F as ae,g as U,T as ne,l as te,e as oe,f as ie}from"./app.f408fb82.js";import{g as f,E as re,L as le}from"./_plugin-vue_export-helper.ba410747.js";import{_ as ce}from"./SiteLayout.vue_vue_type_script_setup_true_lang.5f5bc61b.js";import{_ as ue}from"./FormError.vue_vue_type_script_setup_true_lang.33017437.js";const me={class:"container conversa"},de=o("br",null,null,-1),ge={class:"conteudo"},fe={class:"container-mensagens"},ve={key:0,class:"loader-inline"},pe=o("span",{class:"elemento"},null,-1),_e=[pe],he=["id"],xe=o("span",null,"Novas Mensagens",-1),Me=[xe],be=["onSubmit"],ze={class:"col"},Te={class:"row"},ye={class:"d-flex flex-row"},Ee={class:"col"},Ve=o("button",{type:"submit",class:"btn btn-primary"}," Enviar ",-1),Se={class:"textcount"},Ae=Q({__name:"Conversa",props:{conversa:Object,usuarioId:Number},setup(v){const l=v,M=_.exports.debounce(D,100,{maxWait:250});_.exports.debounce(T,500,{maxWait:1e4});const b=25,k=2500;let r=l.conversa.visualizacao.ultima_mensagem_id;const t=y(null);let q=y(f().temPermissao()),c=y("");const a=R({mensagens:l.conversa.mensagens,mensagem:"",mensagensAnteriores:!1,novasMensagens:!1});re.addListener(new le(G,1)),X(()=>{t.value.scrollHeight>t.value.clientHeight+b&&(a.mensagensAnteriores=!0),E(C)});function B(){return h.post(`/conversa/${l.conversa.id}/enviar`,{mensagem:a.mensagem}).then(()=>{a.mensagem="",c.value="",K()}).catch(e=>{var s,n,m,d,H,P,w,N;if((m=(n=(s=e==null?void 0:e.response)==null?void 0:s.data)==null?void 0:n.errors)!=null&&m.mensagem){if(Array.isArray((P=(H=(d=e==null?void 0:e.response)==null?void 0:d.data)==null?void 0:H.errors)==null?void 0:P.mensagem)){[c.value]=e.response.data.errors.mensagem;return}c.value=e.response.data.errors.mensagem;return}if((N=(w=e==null?void 0:e.response)==null?void 0:w.data)!=null&&N.message){c.value=e.response.data.message;return}c.value="Erro ao enviar mensagem",setTimeout(()=>{location.reload()},5e3)})}function F(){return a.mensagens.findLast(e=>e.id<=r)}function C(){var s,n;const e=F();e&&p(z(e.id)-t.value.clientHeight/2),t.value.scrollTop<((s=t.value.querySelector(".loader-inline"))==null?void 0:s.clientHeight)&&p((n=t.value.querySelector(".loader-inline"))==null?void 0:n.clientHeight),E($)}function O(){a.novasMensagens=!1;const e=j();e?(p(z(e.id)-t.value.clientHeight/2),r=e.id,T()):C()}function j(){return a.mensagens.find(e=>e.id>r)}function p(e){t.value.scrollTop=e,setTimeout(()=>{M.cancel()},100)}function z(e){return t.value.querySelector(`#msg-${e}`).offsetTop-t.value.offsetTop}function D(e){t.value.scrollTop<=b&&J(),$(),t.value.scrollTop+t.value.clientHeight>=t.value.scrollHeight-b&&(a.novasMensagens=!1)}function $(){const e=W();e&&e.id>r&&(r=e.id,T())}function W(){const e=a.mensagens.findIndex(s=>s.id>r);return a.mensagens.slice(e).findLast(s=>Z(s.id))}function Z(e){const s=t.value.querySelector(`#msg-${e}`),n=s.offsetTop+s.clientHeight-s.parentElement.offsetTop;return n>s.parentElement.scrollTop&&n<s.parentElement.scrollTop+s.parentElement.clientHeight}function T(){h.post(`/conversa/${l.conversa.id}/mensagens/visualizacao/${r}`)}function i(){function e(){var n,m;let s=(m=(n=_.exports.last(a.mensagens))==null?void 0:n.id)!=null?m:0;return h.get(`/conversa/${l.conversa.id}/mensagens/posteriores/${s}`).then(d=>{d.data.mensagens.length>0&&(a.mensagens=a.mensagens.concat(d.data.mensagens),a.novasMensagens=!0)})}if(i.bloquear){i.atualizar=!0;return}i.bloquear=!0,i.atualizar=!1,e().finally(()=>{i.bloquear=!1,i.atualizar&&i()})}function G(e){var s,n;e.mensagem_id>((n=(s=_.exports.last(a.mensagens))==null?void 0:s.id)!=null?n:0)&&i()}function J(){if(!a.mensagensAnteriores||a.mensagens>0)return;const e=a.mensagens[0].id;h.get(`/conversa/${l.conversa.id}/mensagens/anteriores/${e}`).then(s=>{a.mensagens=s.data.mensagens.concat(a.mensagens),a.mensagensAnteriores=s.data.mais,E(()=>{p(z(e))})})}function A(){f().solicitarPermissao().then(()=>{q.value=f().temPermissao()})}function K(){f().jaSolicitouPermissao()||f().temPermissao()||A()}return(e,s)=>(u(),Y(ce,{titulo:`Conversa ${v.conversa.equipamento.titulo}`},{default:I(()=>[o("div",me,[o("h2",null,"Conversa - "+V(v.conversa.equipamento.titulo),1),x(q)?S("",!0):(u(),g("div",{key:0,class:"alert alert-warning mt-2 mb-4 cursor-pointer",onClick:A},[L(" Voc\xEA n\xE3o ir\xE1 receber notifica\xE7\xF5es de novas mensagens."),de,L(" Clique aqui para autorizar as Notifica\xE7\xF5es ")])),o("div",ge,[o("div",fe,[o("div",{ref_key:"elMensagens",ref:t,class:"mensagens",onScroll:s[0]||(s[0]=(...n)=>x(M)&&x(M)(...n))},[a.mensagensAnteriores?(u(),g("div",ve,_e)):S("",!0),(u(!0),g(ae,null,ee(a.mensagens,n=>(u(),g("span",{id:"msg-"+n.id,key:n.id,class:se(["mensagem",{autor:n.usuario_id==v.usuarioId}])},V(n.mensagem),11,he))),128))],544),U(ne,{name:"fade-transition",duration:100},{default:I(()=>[a.novasMensagens?(u(),g("button",{key:0,type:"button",class:"novas-mensagens",onClick:O},Me)):S("",!0)]),_:1})]),o("form",{class:"mensagens-footer",onSubmit:te(B,["prevent"])},[o("div",ze,[o("div",Te,[U(ue,{error:x(c)},null,8,["error"])]),o("div",ye,[oe(o("textarea",{"onUpdate:modelValue":s[1]||(s[1]=n=>a.mensagem=n),class:"form-control",maxlength:k,rows:"3"},null,512),[[ie,a.mensagem]]),o("div",Ee,[Ve,o("span",Se,V(a.mensagem.length+" / "+k),1)])])])],40,be)])])]),_:1},8,["titulo"]))}});export{Ae as default};
