import{X as V,l as B,B as N,m as D,U as p,C as m,o as c,a as I,w as y,b as i,t as M,e as o,h as d,j as S,r as F,D as O,F as P,f as W,T as j,k as X,d as $,v as G}from"./app.a5fa58c3.js";import{_ as J}from"./SiteLayout.8f32fc18.js";import{E as K}from"./_plugin-vue_export-helper.e8f8e49e.js";const Q={class:"container conversa"},R={class:"conteudo"},Y={class:"container-mensagens"},Z={key:0,class:"loader-inline"},ee=i("span",{class:"elemento"},null,-1),ne=[ee],se=["id"],ae=i("span",null,"Novas Mensagens",-1),te=[ae],ie=["onSubmit"],oe={class:"col"},le=i("button",{type:"submit",class:"btn btn-primary"},"Enviar",-1),re={class:"textcount"},de={__name:"Conversa",props:["conversa","usuario_id"],setup(g){const r=g;let f=V.exports.debounce(E,100,{maxWait:250});V.exports.debounce(h,500,{maxWait:1e4});const v=25,x=2500;let l=r.conversa.visualizacao.ultima_mensagem_id;const t=B(null);let s=N({mensagens:r.conversa.mensagens,mensagem:"",mensagensAnteriores:!1,novasMensagens:!1});K.addListener(q),D(()=>{t.value.scrollHeight>t.value.clientHeight+v&&(s.mensagensAnteriores=!0),p(T)});function b(){return m.post(route("site.conversa.enviar",r.conversa.id),{mensagem:s.mensagem}).then(()=>{s.mensagem=""}).catch(e=>{location.reload()})}function k(){return s.mensagens.findLast(e=>e.id<=l)}function T(){var n,a;let e=k();e&&u(_(e.id)-t.value.clientHeight/2),t.value.scrollTop<((n=t.value.querySelector(".loader-inline"))==null?void 0:n.clientHeight)&&u((a=t.value.querySelector(".loader-inline"))==null?void 0:a.clientHeight),p(z)}function H(){s.novasMensagens=!1;let e=C();e?(u(_(e.id)-t.value.clientHeight/2),l=e.id,h()):T()}function C(){return s.mensagens.find(e=>e.id>l)}function u(e){t.value.scrollTop=e,setTimeout(()=>{f.cancel()},100)}function _(e){return t.value.querySelector("#msg-"+e).offsetTop-t.value.offsetTop}function E(e){t.value.scrollTop<=v&&w(),z(),t.value.scrollTop+t.value.clientHeight>=t.value.scrollHeight-v&&(s.novasMensagens=!1)}function z(){let e=U();e&&e.id>l&&(l=e.id,h())}function U(){let e=s.mensagens.findIndex(n=>n.id>l);return s.mensagens.slice(e).findLast(n=>A(n.id))}function A(e){let n=t.value.querySelector("#msg-"+e),a=n.offsetTop+n.clientHeight-n.parentElement.offsetTop;return a>n.parentElement.scrollTop&&a<n.parentElement.scrollTop+n.parentElement.clientHeight}function h(){m.post(route("site.conversa.mensagens.visualizacao",[r.conversa.id,l]))}function L(){var e,n;m.get(route("site.conversa.mensagens",[r.conversa.id,(n=(e=s.mensagens.findLast(()=>!0))==null?void 0:e.id)!=null?n:0])).then(a=>{a.data.mensagens.length>0&&(s.mensagens=s.mensagens.concat(a.data.mensagens),s.novasMensagens=!0)})}function q(e){var n,a;e.mensagem_id>((a=(n=s.mensagens.findLast(()=>!0))==null?void 0:n.id)!=null?a:0)&&(L(),e.cancelled=!0)}function w(){if(!s.mensagensAnteriores||s.mensagens>0)return;let e=s.mensagens[0].id;m.get(route("site.conversa.mensagens.anteriores",[r.conversa.id,e])).then(n=>{s.mensagens=n.data.mensagens.concat(s.mensagens),s.mensagensAnteriores=n.data.mais,p(()=>{u(_(e))})})}return(e,n)=>(c(),I(J,null,{default:y(()=>[i("div",Q,[i("h2",null,"Conversa - "+M(g.conversa.equipamento.titulo),1),i("div",R,[i("div",Y,[i("div",{class:"mensagens",onScroll:n[0]||(n[0]=(...a)=>o(f)&&o(f)(...a)),ref_key:"elMensagens",ref:t},[o(s).mensagensAnteriores?(c(),d("div",Z,ne)):S("",!0),(c(!0),d(P,null,F(o(s).mensagens,a=>(c(),d("span",{class:O(["mensagem",{autor:a.usuario_id==g.usuario_id}]),id:"msg-"+a.id,key:a.id},M(a.mensagem),11,se))),128))],544),W(j,{name:"fade-transition",duration:"100"},{default:y(()=>[o(s).novasMensagens?(c(),d("button",{key:0,class:"novas-mensagens",onClick:H},te)):S("",!0)]),_:1})]),i("form",{onSubmit:X(b,["prevent"]),class:"mensagens-footer"},[$(i("textarea",{class:"form-control","onUpdate:modelValue":n[1]||(n[1]=a=>o(s).mensagem=a),maxlength:x,rows:"3"},null,512),[[G,o(s).mensagem]]),i("div",oe,[le,i("span",re,M(o(s).mensagem.length+" / "+x),1)])],40,ie)])])]),_:1}))}};export{de as default};
