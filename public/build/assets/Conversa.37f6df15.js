var N=Object.defineProperty;var I=(r,t,l)=>t in r?N(r,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):r[t]=l;var _=(r,t,l)=>(I(r,typeof t!="symbol"?t+"":t,l),l);import{H as W,W as z,k as D,A as F,l as O,S as M,B as g,a as P,w as b,o as m,b as o,t as x,u as c,g as f,i as k,r as j,C as G,F as J,e as K,T as Q,j as R,d as X,v as Y}from"./app.f56e2738.js";import{S as Z}from"./SiteLayout.a4679d3a.js";import{E as $}from"./_plugin-vue_export-helper.67a9e3d9.js";class ee{constructor(t,l=10){_(this,"priority");_(this,"callback");this.priority=l,this.callback=t}}const ne={class:"container conversa"},se={class:"conteudo"},ae={class:"container-mensagens"},te={key:0,class:"loader-inline"},ie=o("span",{class:"elemento"},null,-1),oe=[ie],le=["id"],re=o("span",null,"Novas Mensagens",-1),ce=[re],ue=["onSubmit"],me={class:"col"},de=o("button",{type:"submit",class:"btn btn-primary"},"Enviar",-1),ge={class:"textcount"},_e=W({__name:"Conversa",props:["conversa","usuario_id"],setup(r){const t=r;let l=z.exports.debounce(L,100,{maxWait:250});z.exports.debounce(h,500,{maxWait:1e4});const v=25,T=2500;let u=t.conversa.visualizacao.ultima_mensagem_id;const i=D(null);let s=F({mensagens:t.conversa.mensagens,mensagem:"",mensagensAnteriores:!1,novasMensagens:!1});$.addListener(new ee(q,1)),O(()=>{i.value.scrollHeight>i.value.clientHeight+v&&(s.mensagensAnteriores=!0),M(y)});function V(){return g.post(route("site.conversa.enviar",t.conversa.id),{mensagem:s.mensagem}).then(()=>{s.mensagem=""}).catch(e=>{location.reload()})}function H(){return s.mensagens.findLast(e=>e.id<=u)}function y(){var n,a;let e=H();e&&d(p(e.id)-i.value.clientHeight/2),i.value.scrollTop<((n=i.value.querySelector(".loader-inline"))==null?void 0:n.clientHeight)&&d((a=i.value.querySelector(".loader-inline"))==null?void 0:a.clientHeight),M(S)}function C(){s.novasMensagens=!1;let e=E();e?(d(p(e.id)-i.value.clientHeight/2),u=e.id,h()):y()}function E(){return s.mensagens.find(e=>e.id>u)}function d(e){i.value.scrollTop=e,setTimeout(()=>{l.cancel()},100)}function p(e){return i.value.querySelector("#msg-"+e).offsetTop-i.value.offsetTop}function L(e){i.value.scrollTop<=v&&B(),S(),i.value.scrollTop+i.value.clientHeight>=i.value.scrollHeight-v&&(s.novasMensagens=!1)}function S(){let e=A();e&&e.id>u&&(u=e.id,h())}function A(){let e=s.mensagens.findIndex(n=>n.id>u);return s.mensagens.slice(e).findLast(n=>w(n.id))}function w(e){let n=i.value.querySelector("#msg-"+e),a=n.offsetTop+n.clientHeight-n.parentElement.offsetTop;return a>n.parentElement.scrollTop&&a<n.parentElement.scrollTop+n.parentElement.clientHeight}function h(){g.post(route("site.conversa.mensagens.visualizacao",[t.conversa.id,u]))}function U(){var e,n;g.get(route("site.conversa.mensagens",[t.conversa.id,(n=(e=s.mensagens.findLast(()=>!0))==null?void 0:e.id)!=null?n:0])).then(a=>{a.data.mensagens.length>0&&(s.mensagens=s.mensagens.concat(a.data.mensagens),s.novasMensagens=!0)})}function q(e){var n,a;e.mensagem_id>((a=(n=s.mensagens.findLast(()=>!0))==null?void 0:n.id)!=null?a:0)&&(U(),e.cancelled=!0)}function B(){if(!s.mensagensAnteriores||s.mensagens>0)return;let e=s.mensagens[0].id;g.get(route("site.conversa.mensagens.anteriores",[t.conversa.id,e])).then(n=>{s.mensagens=n.data.mensagens.concat(s.mensagens),s.mensagensAnteriores=n.data.mais,M(()=>{d(p(e))})})}return(e,n)=>(m(),P(Z,null,{default:b(()=>[o("div",ne,[o("h2",null,"Conversa - "+x(r.conversa.equipamento.titulo),1),o("div",se,[o("div",ae,[o("div",{class:"mensagens",onScroll:n[0]||(n[0]=(...a)=>c(l)&&c(l)(...a)),ref_key:"elMensagens",ref:i},[c(s).mensagensAnteriores?(m(),f("div",te,oe)):k("",!0),(m(!0),f(J,null,j(c(s).mensagens,a=>(m(),f("span",{class:G(["mensagem",{autor:a.usuario_id==r.usuario_id}]),id:"msg-"+a.id,key:a.id},x(a.mensagem),11,le))),128))],544),K(Q,{name:"fade-transition",duration:100},{default:b(()=>[c(s).novasMensagens?(m(),f("button",{key:0,class:"novas-mensagens",onClick:C},ce)):k("",!0)]),_:1})]),o("form",{onSubmit:R(V,["prevent"]),class:"mensagens-footer"},[X(o("textarea",{class:"form-control","onUpdate:modelValue":n[1]||(n[1]=a=>c(s).mensagem=a),maxlength:T,rows:"3"},null,512),[[Y,c(s).mensagem]]),o("div",me,[de,o("span",ge,x(c(s).mensagem.length+" / "+T),1)])],40,ue)])])]),_:1}))}});export{_e as default};
