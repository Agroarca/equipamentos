import{X as T,l as B,B as L,m as q,C as u,U as N,o as c,a as D,w as z,b as t,t as p,e as i,h as d,j as V,r as I,D as F,F as O,f as W,T as j,k as P,d as X,v as $}from"./app.7caa7f23.js";import{_ as G}from"./SiteLayout.674b1ae9.js";import{E as J}from"./_plugin-vue_export-helper.f3906d74.js";const K={class:"container conversa"},Q={class:"conteudo"},R={class:"container-mensagens"},Y={key:0,class:"loader-inline"},Z=t("span",{class:"elemento"},null,-1),ee=[Z],ne=["id"],se=t("span",null,"Novas Mensagens",-1),ae=[se],te=["onSubmit"],oe={class:"col"},ie=t("button",{type:"submit",class:"btn btn-primary"},"Enviar",-1),le={class:"textcount"},ue={__name:"Conversa",props:["conversa","usuario_id"],setup(g){const r=g;let f=T.exports.debounce(C,100,{maxWait:250});T.exports.debounce(_,500,{maxWait:1e4});const h=25,M=2500;let l=r.conversa.visualizacao.ultima_mensagem_id;const a=B(null);let s=L({mensagens:r.conversa.mensagens,mensagem:"",mensagensAnteriores:!0,novasMensagens:!1});J.addListener(w),q(()=>{x()});function b(){return u.post(route("site.conversa.enviar",r.conversa.id),{mensagem:s.mensagem}).then(()=>{s.mensagem=""}).catch(e=>{location.reload()})}function k(){return s.mensagens.findLast(e=>e.id<=l)}function x(){let e=k();m(e?v(e.id)-a.value.clientHeight/2:a.value.querySelector(".loader-inline").clientHeight)}function y(){s.novasMensagens=!1;let e=S();e?(m(v(e.id)-a.value.clientHeight/2),l=e.id,_()):x()}function S(){return s.mensagens.find(e=>e.id>l)}function m(e){a.value.scrollTop=e,setTimeout(()=>{f.cancel()},100)}function v(e){return a.value.querySelector("#msg-"+e).offsetTop-a.value.offsetTop}function C(e){a.value.scrollTop<=h&&A();let n=E();n&&n.id>l&&(l=n.id,_()),a.value.scrollTop+a.value.clientHeight>=a.value.scrollHeight-h&&(s.novasMensagens=!1)}function E(){let e=s.mensagens.findIndex(n=>n.id>l);return s.mensagens.slice(e).findLast(n=>H(n.id))}function H(e){let n=a.value.querySelector("#msg-"+e),o=n.offsetTop+n.clientHeight-n.parentElement.offsetTop;return o>n.parentElement.scrollTop&&o<n.parentElement.scrollTop+n.parentElement.clientHeight}function _(){u.post(route("site.conversa.mensagens.visualizacao",[r.conversa.id,l]))}function U(){let e=s.mensagens.findLast(()=>!0);!e||u.get(route("site.conversa.mensagens",[r.conversa.id,e.id])).then(n=>{n.data.mensagens.length>0&&(s.mensagens=s.mensagens.concat(n.data.mensagens),s.novasMensagens=!0)})}function w(e){e.mensagem_id>10&&(U(),e.cancelled=!0)}function A(){if(!s.mensagensAnteriores&&s.mensagens>0)return;let e=s.mensagens[0].id;u.get(route("site.conversa.mensagens.anteriores",[r.conversa.id,e])).then(n=>{s.mensagens=n.data.mensagens.concat(s.mensagens),s.mensagensAnteriores=n.data.mais,N(()=>{m(v(e))})})}return(e,n)=>(c(),D(G,null,{default:z(()=>[t("div",K,[t("h2",null,"Conversa - "+p(g.conversa.equipamento.titulo),1),t("div",Q,[t("div",R,[t("div",{class:"mensagens",onScroll:n[0]||(n[0]=(...o)=>i(f)&&i(f)(...o)),ref_key:"elMensagens",ref:a},[i(s).mensagensAnteriores?(c(),d("div",Y,ee)):V("",!0),(c(!0),d(O,null,I(i(s).mensagens,o=>(c(),d("span",{class:F(["mensagem",{autor:o.usuario_id==g.usuario_id}]),id:"msg-"+o.id,key:o.id},p(o.mensagem),11,ne))),128))],544),W(j,{name:"fade-transition",duration:"100"},{default:z(()=>[i(s).novasMensagens?(c(),d("button",{key:0,class:"novas-mensagens",onClick:y},ae)):V("",!0)]),_:1})]),t("form",{onSubmit:P(b,["prevent"]),class:"mensagens-footer"},[X(t("textarea",{class:"form-control","onUpdate:modelValue":n[1]||(n[1]=o=>i(s).mensagem=o),maxlength:M,rows:"3"},null,512),[[$,i(s).mensagem]]),t("div",oe,[ie,t("span",le,p(i(s).mensagem.length+" / "+M),1)])],40,te)])])]),_:1}))}};export{ue as default};
