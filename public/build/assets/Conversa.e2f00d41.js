import{d as Y,a6 as f,r as z,A as Z,e as ee,W as y,q as v,c as N,w as I,o as m,a as o,t as L,u as h,g as x,i as U,m as $,j as se,F as ne,h as B,T as ae,G as te,D as oe,E as ie}from"./app.4327bc59.js";import{g as p,E as re,L as le}from"./_plugin-vue_export-helper.d1202830.js";import{_ as ce}from"./SiteLayout.vue_vue_type_script_setup_true_lang.d1f1f04d.js";import{_ as me}from"./Mensagem.vue_vue_type_script_setup_true_lang.84f06909.js";import{_ as ue}from"./FormError.vue_vue_type_script_setup_true_lang.79e7a334.js";import"./index.c57ba517.js";import"./Modal.vue_vue_type_script_setup_true_lang.cf7ab79b.js";const de={class:"container conversa"},ge=o("br",null,null,-1),fe={class:"conteudo"},ve={class:"container-mensagens"},pe={key:0,class:"loader-inline"},_e=o("span",{class:"elemento"},null,-1),he=[_e],xe=o("span",null,"Novas Mensagens",-1),Me=[xe],Te=["onSubmit"],be={class:"col"},Ee={class:"row"},ze={class:"d-flex flex-row"},ye={class:"col"},$e=o("button",{type:"submit",class:"btn btn-primary"}," Enviar ",-1),qe={class:"textcount"},we=Y({__name:"Conversa",props:{conversa:Object,usuarioId:Number,mensagensTempoExcluir:Number},setup(u){const l=u,M=f.exports.debounce(W,100,{maxWait:250});f.exports.debounce(E,500,{maxWait:1e4});const T=25,q=2500;let r=l.conversa.visualizacao.ultima_mensagem_id;const t=z(null);let V=z(p().temPermissao()),c=z("");const n=Z({mensagens:l.conversa.mensagens,mensagem:"",mensagensAnteriores:!1,novasMensagens:!1});re.addListener(new le(K,1)),ee(()=>{t.value.scrollHeight>t.value.clientHeight+T&&(n.mensagensAnteriores=!0),y(S)});function F(){return v.post(`/conversa/${l.conversa.id}/enviar`,{mensagem:n.mensagem}).then(()=>{n.mensagem="",c.value="",X()}).catch(e=>{var s,a,d,g,C,P,H,w;if((d=(a=(s=e==null?void 0:e.response)==null?void 0:s.data)==null?void 0:a.errors)!=null&&d.mensagem){if(Array.isArray((P=(C=(g=e==null?void 0:e.response)==null?void 0:g.data)==null?void 0:C.errors)==null?void 0:P.mensagem)){[c.value]=e.response.data.errors.mensagem;return}c.value=e.response.data.errors.mensagem;return}if((w=(H=e==null?void 0:e.response)==null?void 0:H.data)!=null&&w.message){c.value=e.response.data.message;return}c.value="Erro ao enviar mensagem",setTimeout(()=>{location.reload()},5e3)})}function j(){return n.mensagens.findLast(e=>e.id<=r)}function S(){var s,a;const e=j();e&&_(b(e.id)-t.value.clientHeight/2),t.value.scrollTop<((s=t.value.querySelector(".loader-inline"))==null?void 0:s.clientHeight)&&_((a=t.value.querySelector(".loader-inline"))==null?void 0:a.clientHeight),y(k)}function D(){n.novasMensagens=!1;const e=O();e?(_(b(e.id)-t.value.clientHeight/2),r=e.id,E()):S()}function O(){return n.mensagens.find(e=>e.id>r)}function _(e){t.value.scrollTop=e,setTimeout(()=>{M.cancel()},100)}function b(e){return t.value.querySelector(`#msg-${e}`).offsetTop-t.value.offsetTop}function W(e){t.value.scrollTop<=T&&Q(),k(),t.value.scrollTop+t.value.clientHeight>=t.value.scrollHeight-T&&(n.novasMensagens=!1)}function k(){const e=G();e&&e.id>r&&(r=e.id,E())}function G(){const e=n.mensagens.findIndex(s=>s.id>r);return n.mensagens.slice(e).findLast(s=>J(s.id))}function J(e){const s=t.value.querySelector(`#msg-${e}`),a=s.offsetTop+s.clientHeight-s.parentElement.offsetTop;return a>s.parentElement.scrollTop&&a<s.parentElement.scrollTop+s.parentElement.clientHeight}function E(){v.post(`/conversa/${l.conversa.id}/mensagens/visualizacao/${r}`)}function i(){function e(){var a,d;let s=(d=(a=f.exports.last(n.mensagens))==null?void 0:a.id)!=null?d:0;return v.get(`/conversa/${l.conversa.id}/mensagens/posteriores/${s}`).then(g=>{g.data.mensagens.length>0&&(n.mensagens=n.mensagens.concat(g.data.mensagens),n.novasMensagens=!0)})}if(i.bloquear){i.atualizar=!0;return}i.bloquear=!0,i.atualizar=!1,e().finally(()=>{i.bloquear=!1,i.atualizar&&i()})}function K(e){var s,a;e.mensagem_id>((a=(s=f.exports.last(n.mensagens))==null?void 0:s.id)!=null?a:0)&&i()}function Q(){if(!n.mensagensAnteriores||n.mensagens>0)return;const e=n.mensagens[0].id;v.get(`/conversa/${l.conversa.id}/mensagens/anteriores/${e}`).then(s=>{n.mensagens=s.data.mensagens.concat(n.mensagens),n.mensagensAnteriores=s.data.mais,y(()=>{_(b(e))})})}function R(e){v.get(`/conversa/${e.equipamento_conversa_id}/mensagem/excluir/${e.id}`).then(()=>{n.mensagens=f.exports.filter(n.mensagens,s=>e.id!==s.id)})}function A(){p().solicitarPermissao().then(()=>{V.value=p().temPermissao()})}function X(){p().jaSolicitouPermissao()||p().temPermissao()||A()}return(e,s)=>(m(),N(ce,{titulo:`Conversa ${u.conversa.equipamento.titulo}`},{default:I(()=>[o("div",de,[o("h2",null,"Conversa - "+L(u.conversa.equipamento.titulo),1),h(V)?$("",!0):(m(),x("div",{key:0,class:"alert alert-warning mt-2 mb-4 cursor-pointer",onClick:A},[U(" Voc\xEA n\xE3o ir\xE1 receber notifica\xE7\xF5es de novas mensagens."),ge,U(" Clique aqui para autorizar as Notifica\xE7\xF5es ")])),o("div",fe,[o("div",ve,[o("div",{ref_key:"elMensagens",ref:t,class:"mensagens",onScroll:s[0]||(s[0]=(...a)=>h(M)&&h(M)(...a))},[n.mensagensAnteriores?(m(),x("div",pe,he)):$("",!0),(m(!0),x(ne,null,se(n.mensagens,a=>(m(),N(me,{key:a.id,mensagem:a,"usuario-id":u.usuarioId,"mensagens-tempo-excluir":u.mensagensTempoExcluir,onExcluirMensagem:R},null,8,["mensagem","usuario-id","mensagens-tempo-excluir"]))),128))],544),B(ae,{name:"fade-transition",duration:100},{default:I(()=>[n.novasMensagens?(m(),x("button",{key:0,type:"button",class:"novas-mensagens",onClick:D},Me)):$("",!0)]),_:1})]),o("form",{class:"mensagens-footer",onSubmit:te(F,["prevent"])},[o("div",be,[o("div",Ee,[B(ue,{error:h(c)},null,8,["error"])]),o("div",ze,[oe(o("textarea",{"onUpdate:modelValue":s[1]||(s[1]=a=>n.mensagem=a),class:"form-control",maxlength:q,rows:"3"},null,512),[[ie,n.mensagem]]),o("div",ye,[$e,o("span",qe,L(n.mensagem.length+" / "+q),1)])])])],40,Te)])])]),_:1},8,["titulo"]))}});export{we as default};
