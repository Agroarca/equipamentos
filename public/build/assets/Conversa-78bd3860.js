import{r as p,x as X,a5 as b,j as A,d as Y,Z as R,c as Z,w as G,o as y,a as o,t as J,u as d,k as C,h as K,l as W,m as ee,F as ae,f as Q,T as se,g as ne,b as te,e as ie,A as re}from"./app-3e778e05.js";import{_ as oe}from"./SiteLayout.vue_vue_type_script_setup_true_lang-fd539609.js";import{_ as le}from"./Mensagem.vue_vue_type_script_setup_true_lang-bf0fd5ce.js";import{_ as ue}from"./FormError.vue_vue_type_script_setup_true_lang-ab96a0f6.js";import{g as w,E as ce,L as me}from"./_plugin-vue_export-helper-657d6c5b.js";import"./Modal.vue_vue_type_script_setup_true_lang-b3f3a51d.js";import"./index-ac617c56.js";class M{constructor(l,s,c,v,n=!1){this.id=l,this.mensagem=s,this.usuario_id=c,this.created_at=v,this.loading=n}static converterArray(l){return l.map(s=>new M(s.id,s.mensagem,s.usuario_id,s.created_at))}}function de(g,l){let s=p(g.mensagens),c=p(!1),v=p(!1),n=p(w().temPermissao()),f=g.id,u=p(g.visualizacao.ultima_mensagem_id),H=l,x=-1,m={bloquearAtualizar:!1,atualizar:!1,bloquearAtualizarAnteriores:!1};X(()=>{I()});function E(){return s.value.findLast(e=>e.id<=u.value)}function j(e){return s.value.find(t=>t.id>e)}function h(e){e<u.value||(u.value=e,N(e))}async function T(){var e;m.bloquearAtualizar&&(m.atualizar=!0),m.bloquearAtualizar=!0,m.atualizar=!1,await D(((e=b.last(s.value))==null?void 0:e.id)??0),m.bloquearAtualizar=!1,m.atualizar&&T()}function q(){w().solicitarPermissao().then(()=>{n.value=w().temPermissao()})}function L(){w().jaSolicitouPermissao()||w().temPermissao()||q()}async function U(){if(!c.value||s.value.length===0||m.bloquearAtualizarAnteriores)return null;m.bloquearAtualizarAnteriores=!0;const e=b.first(s.value).id;return await B(e),e}async function B(e){let t=await A.get(`/conversa/${f}/mensagens/anteriores/${e}`);s.value=M.converterArray(t.data.mensagens).concat(s.value),c.value=t.data.mais}async function D(e){let t=await A.get(`/conversa/${f}/mensagens/posteriores/${e}`);t.data.mensagens.length>0&&(s.value=s.value.concat(M.converterArray(t.data.mensagens)),v.value=!0)}async function V(e){let t=await A.post(`/conversa/${f}/enviar`,{mensagem:e});s.value.push(new M(t.data.id,t.data.mensagem,t.data.usuario_id,t.data.created_at))}function N(e){A.post(`/conversa/${f}/mensagens/visualizacao/${e}`)}function O(e){A.get(`/conversa/${f}/mensagem/excluir/${e}`).then(()=>{s.value=b.filter(s.value,t=>e!==t.id)})}function I(){ce.addListener(new me(e=>{var t;e.mensagem_id>(((t=b.last(s.value))==null?void 0:t.id)??0)&&T()},1))}async function F(e){let t=new M(x,e,H,new Date,!0);x-=1,s.value.push(t),await V(t.mensagem),s.value=b.filter(s.value,_=>_.id!==t.id),L()}function z(e){var t,_,P,$,S,k,a,i;if((P=(_=(t=e==null?void 0:e.response)==null?void 0:t.data)==null?void 0:_.errors)!=null&&P.mensagem){if(Array.isArray((k=(S=($=e==null?void 0:e.response)==null?void 0:$.data)==null?void 0:S.errors)==null?void 0:k.mensagem)){let[r]=e.response.data.errors.mensagem;return r}return e.response.data.errors.mensagem}return(i=(a=e==null?void 0:e.response)==null?void 0:a.data)!=null&&i.message?e.response.data.message:"Erro ao enviar mensagem"}return{mensagens:s,mensagensAnteriores:c,temNovasMensagens:v,temPermNotificacao:n,ultimaMsgVisualizadaId:u,ajaxExcluirMensagem:O,atualizarMensagensAnteriores:U,enviarMensagem:F,getMensagemErroEnviarMensagem:z,getProximaMensagem:j,getUltimaMensagemVisualizada:E,solicitarPermNotificacao:q,visualizarMensagem:h}}class ge{constructor(l,s,c,v){this.id=l,this.equipamento_id=s,this.visualizacao=c,this.mensagens=v.map(n=>new M(n.id,n.mensagem,n.usuario_id,n.created_at))}}const ve={class:"container conversa"},fe=o("br",null,null,-1),pe={class:"conteudo"},he={class:"container-mensagens"},_e={key:0,class:"loader-inline"},Me=o("span",{class:"elemento"},null,-1),xe=[Me],ze=o("span",null,"Novas Mensagens",-1),ye=[ze],be=["onSubmit"],Ee={class:"col"},Ae={class:"row"},we={class:"d-flex flex-row"},Te={class:"col"},qe=o("button",{type:"submit",class:"btn btn-primary"}," Enviar ",-1),Ve={class:"textcount"},He=Y({__name:"Conversa",props:{conversa:Object,usuarioId:Number,mensagensTempoExcluir:Number},setup(g){const l=g,s=b.debounce(t,100,{maxWait:250}),c=25,v=2500,n=p(null);let f=p(""),u=p(""),H=new ge(l.conversa.id,l.conversa.equipamentoId,l.conversa.visualizacao,l.conversa.mensagens);const{mensagens:x,mensagensAnteriores:m,temNovasMensagens:E,temPermNotificacao:j,ultimaMsgVisualizadaId:h,ajaxExcluirMensagem:T,atualizarMensagensAnteriores:q,enviarMensagem:L,getMensagemErroEnviarMensagem:U,getProximaMensagem:B,getUltimaMensagemVisualizada:D,solicitarPermNotificacao:V,visualizarMensagem:N}=de(H,l.usuarioId);X(()=>{n.value.scrollHeight>n.value.clientHeight+c&&(m.value=!0),R(I)});async function O(){try{let a=u.value.trim();u.value="",await L(a)}catch(a){f.value=U(a),setTimeout(()=>{location.reload()},5e3)}}function I(){var i,r;const a=D();a&&z(e(a.id)-n.value.clientHeight/2),n.value.scrollTop<((i=n.value.querySelector(".loader-inline"))==null?void 0:i.clientHeight)&&z((r=n.value.querySelector(".loader-inline"))==null?void 0:r.clientHeight),R(_)}function F(){E.value=!1;const a=B(h);a?(z(e(a.id)-n.value.clientHeight/2),N(a.id)):I()}function z(a){n.value.scrollTop=a,setTimeout(()=>{s.cancel()},100)}function e(a){return n.value.querySelector(`#msg-${a}`).offsetTop-n.value.offsetTop}function t(){n.value.scrollTop<=c&&S(),_(),n.value.scrollTop+n.value.clientHeight>=n.value.scrollHeight-c&&(E.value=!1)}function _(){const a=P();a&&a.id>h&&(h.value=a.id,N(h.value))}function P(){const a=x.value.findIndex(i=>i.id>h.value);return x.value.slice(a).findLast(i=>$(i.id))}function $(a){const i=n.value.querySelector(`#msg-${a}`),r=i.offsetTop+i.clientHeight-i.parentElement.offsetTop;return r>i.parentElement.scrollTop&&r<i.parentElement.scrollTop+i.parentElement.clientHeight}function S(){let a=q();a&&R(()=>{z(e(a))})}function k(a){T(a.id)}return(a,i)=>(y(),Z(oe,{titulo:`Conversa ${g.conversa.equipamento.titulo}`},{default:G(()=>[o("div",ve,[o("h2",null,"Conversa - "+J(g.conversa.equipamento.titulo),1),d(j)?W("",!0):(y(),C("div",{key:0,class:"alert alert-warning mt-2 mb-4 cursor-pointer",onClick:i[0]||(i[0]=(...r)=>d(V)&&d(V)(...r))},[K(" Você não irá receber notificações de novas mensagens."),fe,K(" Clique aqui para autorizar as Notificações ")])),o("div",pe,[o("div",he,[o("div",{ref_key:"elMensagens",ref:n,class:"mensagens",onScroll:i[1]||(i[1]=(...r)=>d(s)&&d(s)(...r))},[d(m)?(y(),C("div",_e,xe)):W("",!0),(y(!0),C(ae,null,ee(d(x),r=>(y(),Z(le,{key:r.id,mensagem:r,usuarioId:g.usuarioId,mensagensTempoExcluir:g.mensagensTempoExcluir,onExcluirMensagem:k},null,8,["mensagem","usuarioId","mensagensTempoExcluir"]))),128))],544),Q(se,{name:"fade-transition",duration:100},{default:G(()=>[d(E)?(y(),C("button",{key:0,type:"button",class:"novas-mensagens",onClick:F},ye)):W("",!0)]),_:1})]),o("form",{class:"mensagens-footer",onSubmit:ne(O,["prevent"])},[o("div",Ee,[o("div",Ae,[Q(ue,{error:d(f)},null,8,["error"])]),o("div",we,[te(o("textarea",{"onUpdate:modelValue":i[2]||(i[2]=r=>re(u)?u.value=r:u=r),class:"form-control",maxlength:v,rows:"3"},null,512),[[ie,d(u)]]),o("div",Te,[qe,o("span",Ve,J(d(u).length+" / "+v),1)])])])],40,be)])])]),_:1},8,["titulo"]))}});export{He as default};
