import{d as Z,$ as u,m as q,H as G,n as J,Z as M,A as m,a as H,w as P,o as c,b as i,t as C,u as b,i as v,s as A,k as T,r as K,F as Q,g as R,T as X,l as Y,e as ee,f as ne}from"./app.7f8c5bb8.js";import{g,E as se,L as ae}from"./_plugin-vue_export-helper.2802e0fb.js";import{_ as te}from"./SiteLayout.vue_vue_type_script_setup_true_lang.04cfef76.js";import{_ as ie}from"./Mensagem.vue_vue_type_script_setup_true_lang.b9b971ea.js";import"./Modal.vue_vue_type_script_setup_true_lang.3d09cfaa.js";const oe={class:"container conversa"},re=i("br",null,null,-1),le={class:"conteudo"},ce={class:"container-mensagens"},ue={key:0,class:"loader-inline"},me=i("span",{class:"elemento"},null,-1),ge=[me],de=i("span",null,"Novas Mensagens",-1),fe=[de],ve=["onSubmit"],pe={class:"col"},he=i("button",{type:"submit",class:"btn btn-primary"}," Enviar ",-1),xe={class:"textcount"},Ee=Z({__name:"Conversa",props:{conversa:Object,usuarioId:Number,mensagensTempoExcluir:Number},setup(d){const l=d,p=u.exports.debounce(U,100,{maxWait:250});u.exports.debounce(_,500,{maxWait:1e4});const h=25,z=2500;let r=l.conversa.visualizacao.ultima_mensagem_id;const t=q(null);let E=q(g().temPermissao());const n=G({mensagens:l.conversa.mensagens,mensagem:"",mensagensAnteriores:!1,novasMensagens:!1});se.addListener(new ae(O,1)),J(()=>{t.value.scrollHeight>t.value.clientHeight+h&&(n.mensagensAnteriores=!0),M(y)});function N(){return m.post(`/conversa/${l.conversa.id}/enviar`,{mensagem:n.mensagem}).then(()=>{n.mensagem="",W()}).catch(e=>{location.reload()})}function w(){return n.mensagens.findLast(e=>e.id<=r)}function y(){var s,a;const e=w();e&&f(x(e.id)-t.value.clientHeight/2),t.value.scrollTop<((s=t.value.querySelector(".loader-inline"))==null?void 0:s.clientHeight)&&f((a=t.value.querySelector(".loader-inline"))==null?void 0:a.clientHeight),M(V)}function I(){n.novasMensagens=!1;const e=L();e?(f(x(e.id)-t.value.clientHeight/2),r=e.id,_()):y()}function L(){return n.mensagens.find(e=>e.id>r)}function f(e){t.value.scrollTop=e,setTimeout(()=>{p.cancel()},100)}function x(e){return t.value.querySelector(`#msg-${e}`).offsetTop-t.value.offsetTop}function U(e){t.value.scrollTop<=h&&j(),V(),t.value.scrollTop+t.value.clientHeight>=t.value.scrollHeight-h&&(n.novasMensagens=!1)}function V(){const e=B();e&&e.id>r&&(r=e.id,_())}function B(){const e=n.mensagens.findIndex(s=>s.id>r);return n.mensagens.slice(e).findLast(s=>F(s.id))}function F(e){const s=t.value.querySelector(`#msg-${e}`),a=s.offsetTop+s.clientHeight-s.parentElement.offsetTop;return a>s.parentElement.scrollTop&&a<s.parentElement.scrollTop+s.parentElement.clientHeight}function _(){m.post(`/conversa/${l.conversa.id}/mensagens/visualizacao/${r}`)}function o(){function e(){var a,S;let s=(S=(a=u.exports.last(n.mensagens))==null?void 0:a.id)!=null?S:0;return m.get(`/conversa/${l.conversa.id}/mensagens/posteriores/${s}`).then(k=>{k.data.mensagens.length>0&&(n.mensagens=n.mensagens.concat(k.data.mensagens),n.novasMensagens=!0)})}if(o.bloquear){o.atualizar=!0;return}o.bloquear=!0,o.atualizar=!1,e().finally(()=>{o.bloquear=!1,o.atualizar&&o()})}function O(e){var s,a;e.mensagem_id>((a=(s=u.exports.last(n.mensagens))==null?void 0:s.id)!=null?a:0)&&o()}function j(){if(!n.mensagensAnteriores||n.mensagens>0)return;const e=n.mensagens[0].id;m.get(`/conversa/${l.conversa.id}/mensagens/anteriores/${e}`).then(s=>{n.mensagens=s.data.mensagens.concat(n.mensagens),n.mensagensAnteriores=s.data.mais,M(()=>{f(x(e))})})}function D(e){m.get(`/conversa/${e.equipamento_conversa_id}/mensagem/excluir/${e.id}`).then(()=>{n.mensagens=u.exports.filter(n.mensagens,s=>e.id!==s.id)})}function $(){g().solicitarPermissao().then(()=>{E.value=g().temPermissao()})}function W(){g().jaSolicitouPermissao()||g().temPermissao()||$()}return(e,s)=>(c(),H(te,null,{default:P(()=>[i("div",oe,[i("h2",null,"Conversa - "+C(d.conversa.equipamento.titulo),1),b(E)?T("",!0):(c(),v("div",{key:0,class:"alert alert-warning mt-2 mb-4 cursor-pointer",onClick:$},[A(" Voc\xEA n\xE3o ir\xE1 receber notifica\xE7\xF5es de novas mensagens."),re,A(" Clique aqui para autorizar as Notifica\xE7\xF5es ")])),i("div",le,[i("div",ce,[i("div",{ref_key:"elMensagens",ref:t,class:"mensagens",onScroll:s[0]||(s[0]=(...a)=>b(p)&&b(p)(...a))},[n.mensagensAnteriores?(c(),v("div",ue,ge)):T("",!0),(c(!0),v(Q,null,K(n.mensagens,a=>(c(),H(ie,{key:a.id,mensagem:a,"usuario-id":d.usuarioId,"mensagens-tempo-excluir":d.mensagensTempoExcluir,onExcluirMensagem:D},null,8,["mensagem","usuario-id","mensagens-tempo-excluir"]))),128))],544),R(X,{name:"fade-transition",duration:100},{default:P(()=>[n.novasMensagens?(c(),v("button",{key:0,type:"button",class:"novas-mensagens",onClick:I},fe)):T("",!0)]),_:1})]),i("form",{class:"mensagens-footer",onSubmit:Y(N,["prevent"])},[ee(i("textarea",{"onUpdate:modelValue":s[1]||(s[1]=a=>n.mensagem=a),class:"form-control",maxlength:z,rows:"3"},null,512),[[ne,n.mensagem]]),i("div",pe,[he,i("span",xe,C(n.mensagem.length+" / "+z),1)])],40,ve)])])]),_:1}))}});export{Ee as default};
