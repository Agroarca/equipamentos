import{d as N,$ as c,m as O,H as D,n as F,Z as h,B as u,a as y,w as V,o as m,b as o,t as H,u as S,i as x,k,r as P,F as W,g as j,T as Z,l as G,e as J,f as K}from"./app.20e2c3b2.js";import{E as Q,L as R}from"./_plugin-vue_export-helper.5b5bb059.js";import{_ as X}from"./SiteLayout.vue_vue_type_script_setup_true_lang.e67c04cb.js";import{_ as Y}from"./Mensagem.vue_vue_type_script_setup_true_lang.835c6fd3.js";import"./Modal.vue_vue_type_script_setup_true_lang.7fd2132e.js";const ee={class:"container conversa"},ne={class:"conteudo"},se={class:"container-mensagens"},ae={key:0,class:"loader-inline"},te=o("span",{class:"elemento"},null,-1),oe=[te],ie=o("span",null,"Novas Mensagens",-1),re=[ie],le=["onSubmit"],ce={class:"col"},ue=o("button",{type:"submit",class:"btn btn-primary"}," Enviar ",-1),me={class:"textcount"},_e=N({__name:"Conversa",props:{conversa:Object,usuarioId:Number},setup(g){const l=g,f=c.exports.debounce($,100,{maxWait:250});c.exports.debounce(_,500,{maxWait:1e4});const v=25,M=2500;let r=l.conversa.visualizacao.ultima_mensagem_id;const t=O(null),s=D({mensagens:l.conversa.mensagens,mensagem:"",mensagensAnteriores:!1,novasMensagens:!1});Q.addListener(new R(U,1)),F(()=>{t.value.scrollHeight>t.value.clientHeight+v&&(s.mensagensAnteriores=!0),h(b)});function q(){return u.post(route("site.conversa.enviar",l.conversa.id),{mensagem:s.mensagem}).then(()=>{s.mensagem=""}).catch(e=>{location.reload()})}function E(){return s.mensagens.findLast(e=>e.id<=r)}function b(){var n,a;const e=E();e&&d(p(e.id)-t.value.clientHeight/2),t.value.scrollTop<((n=t.value.querySelector(".loader-inline"))==null?void 0:n.clientHeight)&&d((a=t.value.querySelector(".loader-inline"))==null?void 0:a.clientHeight),h(z)}function C(){s.novasMensagens=!1;const e=A();e?(d(p(e.id)-t.value.clientHeight/2),r=e.id,_()):b()}function A(){return s.mensagens.find(e=>e.id>r)}function d(e){t.value.scrollTop=e,setTimeout(()=>{f.cancel()},100)}function p(e){return t.value.querySelector(`#msg-${e}`).offsetTop-t.value.offsetTop}function $(e){t.value.scrollTop<=v&&B(),z(),t.value.scrollTop+t.value.clientHeight>=t.value.scrollHeight-v&&(s.novasMensagens=!1)}function z(){const e=w();e&&e.id>r&&(r=e.id,_())}function w(){const e=s.mensagens.findIndex(n=>n.id>r);return s.mensagens.slice(e).findLast(n=>L(n.id))}function L(e){const n=t.value.querySelector(`#msg-${e}`),a=n.offsetTop+n.clientHeight-n.parentElement.offsetTop;return a>n.parentElement.scrollTop&&a<n.parentElement.scrollTop+n.parentElement.clientHeight}function _(){u.post(route("site.conversa.mensagens.visualizacao",[l.conversa.id,r]))}function i(){function e(){var n,a;return u.get(route("site.conversa.mensagens",[l.conversa.id,(a=(n=c.exports.last(s.mensagens))==null?void 0:n.id)!=null?a:0])).then(T=>{T.data.mensagens.length>0&&(s.mensagens=s.mensagens.concat(T.data.mensagens),s.novasMensagens=!0)})}if(i.bloquear){i.atualizar=!0;return}i.bloquear=!0,i.atualizar=!1,e().finally(()=>{i.bloquear=!1,i.atualizar&&i()})}function U(e){var n,a;e.mensagem_id>((a=(n=c.exports.last(s.mensagens))==null?void 0:n.id)!=null?a:0)&&i()}function B(){if(!s.mensagensAnteriores||s.mensagens>0)return;const e=s.mensagens[0].id;u.get(route("site.conversa.mensagens.anteriores",[l.conversa.id,e])).then(n=>{s.mensagens=n.data.mensagens.concat(s.mensagens),s.mensagensAnteriores=n.data.mais,h(()=>{d(p(e))})})}function I(e){u.get(`/conversa/${e.equipamento_conversa_id}/mensagem/excluir/${e.id}`).then(()=>{s.mensagens=c.exports.filter(s.mensagens,n=>e.id!==n.id)})}return(e,n)=>(m(),y(X,null,{default:V(()=>[o("div",ee,[o("h2",null,"Conversa - "+H(g.conversa.equipamento.titulo),1),o("div",ne,[o("div",se,[o("div",{ref_key:"elMensagens",ref:t,class:"mensagens",onScroll:n[0]||(n[0]=(...a)=>S(f)&&S(f)(...a))},[s.mensagensAnteriores?(m(),x("div",ae,oe)):k("",!0),(m(!0),x(W,null,P(s.mensagens,a=>(m(),y(Y,{key:a.id,mensagem:a,"usuario-id":g.usuarioId,onExcluirMensagem:I},null,8,["mensagem","usuario-id"]))),128))],544),j(Z,{name:"fade-transition",duration:100},{default:V(()=>[s.novasMensagens?(m(),x("button",{key:0,type:"button",class:"novas-mensagens",onClick:C},re)):k("",!0)]),_:1})]),o("form",{class:"mensagens-footer",onSubmit:G(q,["prevent"])},[J(o("textarea",{"onUpdate:modelValue":n[1]||(n[1]=a=>s.mensagem=a),class:"form-control",maxlength:M,rows:"3"},null,512),[[K,s.mensagem]]),o("div",ce,[ue,o("span",me,H(s.mensagem.length+" / "+M),1)])],40,le)])])]),_:1}))}});export{_e as default};
