import{r as h,x as ee,a5 as _,j as T,d as ae,Z as W,c as G,w as J,o as b,a as o,t as K,u as d,k as C,h as Q,l as Z,m as se,F as ne,f as X,T as te,g as ie,b as re,e as oe,A as le}from"./app-709b5eb4.js";import{_ as ue}from"./SiteLayout.vue_vue_type_script_setup_true_lang-d1a55dde.js";import{_ as ce}from"./Mensagem.vue_vue_type_script_setup_true_lang-18ace31e.js";import{_ as me}from"./FormError.vue_vue_type_script_setup_true_lang-049e2738.js";import{g as q,N as de,L as Y,M as ge}from"./_plugin-vue_export-helper-475adac4.js";import"./Modal.vue_vue_type_script_setup_true_lang-95e393c4.js";import"./index-ac617c56.js";class x{constructor(l,a,c,v,t=!1){this.id=l,this.mensagem=a,this.usuario_id=c,this.created_at=v,this.loading=t}static converterArray(l){return l.map(a=>new x(a.id,a.mensagem,a.usuario_id,a.created_at))}}function ve(g,l){let a=h(g.mensagens),c=h(!1),v=h(!1),t=h(q().temPermissao()),f=g.id,u=h(g.visualizacao.ultima_mensagem_id),H=l,z=-1,m={bloquearAtualizar:!1,atualizar:!1,bloquearAtualizarAnteriores:!1};ee(()=>{$(),R()});function E(){return a.value.findLast(e=>e.id<=u.value)}function j(e){return a.value.find(n=>n.id>e)}function M(e){e<u.value||(u.value=e,P(e))}async function N(){var e;m.bloquearAtualizar&&(m.atualizar=!0),m.bloquearAtualizar=!0,m.atualizar=!1,await O(((e=_.last(a.value))==null?void 0:e.id)??0),m.bloquearAtualizar=!1,m.atualizar&&N()}function V(){q().solicitarPermissao().then(()=>{t.value=q().temPermissao()})}function U(){q().jaSolicitouPermissao()||q().temPermissao()||V()}async function B(){if(!c.value||a.value.length===0||m.bloquearAtualizarAnteriores)return null;m.bloquearAtualizarAnteriores=!0;const e=_.first(a.value).id;return await D(e),e}async function D(e){let n=await T.get(`/conversa/${f}/mensagens/anteriores/${e}`);a.value=x.converterArray(n.data.mensagens).concat(a.value),c.value=n.data.mais}async function O(e){let n=await T.get(`/conversa/${f}/mensagens/posteriores/${e}`);n.data.mensagens.length>0&&(a.value=a.value.concat(x.converterArray(n.data.mensagens)),v.value=!0)}async function I(e){let n=await T.post(`/conversa/${f}/enviar`,{mensagem:e});a.value.push(new x(n.data.id,n.data.mensagem,n.data.usuario_id,n.data.created_at))}function P(e){T.post(`/conversa/${f}/mensagens/visualizacao/${e}`)}function F(e){T.get(`/conversa/${f}/mensagem/excluir/${e}`).then(()=>{a.value=_.filter(a.value,n=>e!==n.id)})}function $(){de.addListener(new Y(e=>{var n;e.mensagem_id>(((n=_.last(a.value))==null?void 0:n.id)??0)&&N()},1))}function R(){ge.addListener(new Y(e=>{a.value=_.filter(a.value,n=>e.mensagem_id!==n.id)},1))}async function y(e){let n=new x(z,e,H,new Date,!0);z-=1,a.value.push(n);try{await I(n.mensagem)}finally{a.value=_.filter(a.value,w=>w.id!==n.id)}U()}function A(e){var n,w,S,k,L,s,i,r;if((S=(w=(n=e==null?void 0:e.response)==null?void 0:n.data)==null?void 0:w.errors)!=null&&S.mensagem){if(Array.isArray((s=(L=(k=e==null?void 0:e.response)==null?void 0:k.data)==null?void 0:L.errors)==null?void 0:s.mensagem)){let[p]=e.response.data.errors.mensagem;return p}return e.response.data.errors.mensagem}return(r=(i=e==null?void 0:e.response)==null?void 0:i.data)!=null&&r.message?e.response.data.message:"Erro ao enviar mensagem"}return{mensagens:a,mensagensAnteriores:c,temNovasMensagens:v,temPermNotificacao:t,ultimaMsgVisualizadaId:u,ajaxExcluirMensagem:F,atualizarMensagensAnteriores:B,enviarMensagem:y,getMensagemErroEnviarMensagem:A,getProximaMensagem:j,getUltimaMensagemVisualizada:E,solicitarPermNotificacao:V,visualizarMensagem:M}}class fe{constructor(l,a,c,v){this.id=l,this.equipamento_id=a,this.visualizacao=c,this.mensagens=v.map(t=>new x(t.id,t.mensagem,t.usuario_id,t.created_at))}}const pe={class:"container conversa"},he=o("br",null,null,-1),Me={class:"conteudo"},_e={class:"container-mensagens"},xe={key:0,class:"loader-inline"},ze=o("span",{class:"elemento"},null,-1),ye=[ze],we=o("span",null,"Novas Mensagens",-1),be=[we],Ee=["onSubmit"],Ae={class:"col"},Te={class:"row"},qe={class:"d-flex flex-row"},Ne={class:"col"},Ve=o("button",{type:"submit",class:"btn btn-primary"}," Enviar ",-1),Ie={class:"textcount"},je=ae({__name:"Conversa",props:{conversa:Object,usuarioId:Number,mensagensTempoExcluir:Number},setup(g){const l=g,a=_.debounce(e,100,{maxWait:250}),c=25,v=2500,t=h(null);let f=h(""),u=h(""),H=new fe(l.conversa.id,l.conversa.equipamentoId,l.conversa.visualizacao,l.conversa.mensagens);const{mensagens:z,mensagensAnteriores:m,temNovasMensagens:E,temPermNotificacao:j,ultimaMsgVisualizadaId:M,ajaxExcluirMensagem:N,atualizarMensagensAnteriores:V,enviarMensagem:U,getMensagemErroEnviarMensagem:B,getProximaMensagem:D,getUltimaMensagemVisualizada:O,solicitarPermNotificacao:I,visualizarMensagem:P}=ve(H,l.usuarioId);ee(()=>{t.value.scrollHeight>t.value.clientHeight+c&&(m.value=!0),W($)});async function F(){var s,i,r;try{let p=u.value.trim();u.value="",f.value="",await U(p)}catch(p){f.value=B(p),((r=(i=(s=p==null?void 0:p.response)==null?void 0:s.data)==null?void 0:i.mensagem)==null?void 0:r.length)===0&&setTimeout(()=>{window.location.reload()},5e3)}}function $(){var i,r;const s=O();s&&y(A(s.id)-t.value.clientHeight/2),t.value.scrollTop<((i=t.value.querySelector(".loader-inline"))==null?void 0:i.clientHeight)&&y((r=t.value.querySelector(".loader-inline"))==null?void 0:r.clientHeight),W(n)}function R(){E.value=!1;const s=D(M);s?(y(A(s.id)-t.value.clientHeight/2),P(s.id)):$()}function y(s){t.value.scrollTop=s,setTimeout(()=>{a.cancel()},100)}function A(s){return t.value.querySelector(`#msg-${s}`).offsetTop-t.value.offsetTop}function e(){t.value.scrollTop<=c&&k(),n(),t.value.scrollTop+t.value.clientHeight>=t.value.scrollHeight-c&&(E.value=!1)}function n(){const s=w();s&&s.id>M&&(M.value=s.id,P(M.value))}function w(){const s=z.value.findIndex(i=>i.id>M.value);return z.value.slice(s).findLast(i=>S(i.id))}function S(s){const i=t.value.querySelector(`#msg-${s}`),r=i.offsetTop+i.clientHeight-i.parentElement.offsetTop;return r>i.parentElement.scrollTop&&r<i.parentElement.scrollTop+i.parentElement.clientHeight}function k(){let s=V();s&&W(()=>{y(A(s))})}function L(s){N(s.id)}return(s,i)=>(b(),G(ue,{titulo:`Conversa ${g.conversa.equipamento.titulo}`},{default:J(()=>[o("div",pe,[o("h2",null,"Conversa - "+K(g.conversa.equipamento.titulo),1),d(j)?Z("",!0):(b(),C("div",{key:0,class:"alert alert-warning mt-2 mb-4 cursor-pointer",onClick:i[0]||(i[0]=(...r)=>d(I)&&d(I)(...r))},[Q(" Você não irá receber notificações de novas mensagens."),he,Q(" Clique aqui para autorizar as Notificações ")])),o("div",Me,[o("div",_e,[o("div",{ref_key:"elMensagens",ref:t,class:"mensagens",onScroll:i[1]||(i[1]=(...r)=>d(a)&&d(a)(...r))},[d(m)?(b(),C("div",xe,ye)):Z("",!0),(b(!0),C(ne,null,se(d(z),r=>(b(),G(ce,{key:r.id,mensagem:r,usuarioId:g.usuarioId,mensagensTempoExcluir:g.mensagensTempoExcluir,onExcluirMensagem:L},null,8,["mensagem","usuarioId","mensagensTempoExcluir"]))),128))],544),X(te,{name:"fade-transition",duration:100},{default:J(()=>[d(E)?(b(),C("button",{key:0,type:"button",class:"novas-mensagens",onClick:R},be)):Z("",!0)]),_:1})]),o("form",{class:"mensagens-footer",onSubmit:ie(F,["prevent"])},[o("div",Ae,[o("div",Te,[X(me,{error:d(f)},null,8,["error"])]),o("div",qe,[re(o("textarea",{"onUpdate:modelValue":i[2]||(i[2]=r=>le(u)?u.value=r:u=r),class:"form-control",maxlength:v,rows:"3"},null,512),[[oe,d(u)]]),o("div",Ne,[Ve,o("span",Ie,K(d(u).length+" / "+v),1)])])])],40,Ee)])])]),_:1},8,["titulo"]))}});export{je as default};
