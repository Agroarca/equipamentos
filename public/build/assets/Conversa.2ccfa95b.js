import{D as I,_ as m,l as N,H as D,m as W,W as M,A as d,a as F,w as S,o as c,b as o,t as x,u as V,h as g,j as H,r as O,I as P,F as $,f as j,T as G,k as J,d as K,e as Q}from"./app.7e7e5dc5.js";import{E as R,L as X}from"./_plugin-vue_export-helper.2a550d3a.js";import{S as Y}from"./SiteLayout.f1d2e752.js";const Z={class:"container conversa"},ee={class:"conteudo"},ne={class:"container-mensagens"},se={key:0,class:"loader-inline"},ae=o("span",{class:"elemento"},null,-1),te=[ae],oe=["id"],ie=o("span",null,"Novas Mensagens",-1),le=[ie],re=["onSubmit"],ce={class:"col"},ue=o("button",{type:"submit",class:"btn btn-primary"}," Enviar ",-1),me={class:"textcount"},ve=I({__name:"Conversa",props:["conversa","usuario_id"],setup(f){const r=f,v=m.exports.debounce(E,100,{maxWait:250});m.exports.debounce(_,500,{maxWait:1e4});const p=25,z=2500;let l=r.conversa.visualizacao.ultima_mensagem_id;const t=N(null),s=D({mensagens:r.conversa.mensagens,mensagem:"",mensagensAnteriores:!1,novasMensagens:!1});R.addListener(new X(U,1)),W(()=>{t.value.scrollHeight>t.value.clientHeight+p&&(s.mensagensAnteriores=!0),M(T)});function k(){return d.post(route("site.conversa.enviar",r.conversa.id),{mensagem:s.mensagem}).then(()=>{s.mensagem=""}).catch(e=>{location.reload()})}function q(){return s.mensagens.findLast(e=>e.id<=l)}function T(){var n,a;const e=q();e&&u(h(e.id)-t.value.clientHeight/2),t.value.scrollTop<((n=t.value.querySelector(".loader-inline"))==null?void 0:n.clientHeight)&&u((a=t.value.querySelector(".loader-inline"))==null?void 0:a.clientHeight),M(b)}function C(){s.novasMensagens=!1;const e=A();e?(u(h(e.id)-t.value.clientHeight/2),l=e.id,_()):T()}function A(){return s.mensagens.find(e=>e.id>l)}function u(e){t.value.scrollTop=e,setTimeout(()=>{v.cancel()},100)}function h(e){return t.value.querySelector(`#msg-${e}`).offsetTop-t.value.offsetTop}function E(e){t.value.scrollTop<=p&&B(),b(),t.value.scrollTop+t.value.clientHeight>=t.value.scrollHeight-p&&(s.novasMensagens=!1)}function b(){const e=L();e&&e.id>l&&(l=e.id,_())}function L(){const e=s.mensagens.findIndex(n=>n.id>l);return s.mensagens.slice(e).findLast(n=>w(n.id))}function w(e){const n=t.value.querySelector(`#msg-${e}`),a=n.offsetTop+n.clientHeight-n.parentElement.offsetTop;return a>n.parentElement.scrollTop&&a<n.parentElement.scrollTop+n.parentElement.clientHeight}function _(){d.post(route("site.conversa.mensagens.visualizacao",[r.conversa.id,l]))}function i(){function e(){var n,a;return d.get(route("site.conversa.mensagens",[r.conversa.id,(a=(n=m.exports.last(s.mensagens))==null?void 0:n.id)!=null?a:0])).then(y=>{y.data.mensagens.length>0&&(s.mensagens=s.mensagens.concat(y.data.mensagens),s.novasMensagens=!0)})}if(i.bloquear){i.atualizar=!0;return}i.bloquear=!0,i.atualizar=!1,e().finally(()=>{i.bloquear=!1,i.atualizar&&i()})}function U(e){var n,a;e.mensagem_id>((a=(n=m.exports.last(s.mensagens))==null?void 0:n.id)!=null?a:0)&&i()}function B(){if(!s.mensagensAnteriores||s.mensagens>0)return;const e=s.mensagens[0].id;d.get(route("site.conversa.mensagens.anteriores",[r.conversa.id,e])).then(n=>{s.mensagens=n.data.mensagens.concat(s.mensagens),s.mensagensAnteriores=n.data.mais,M(()=>{u(h(e))})})}return(e,n)=>(c(),F(Y,null,{default:S(()=>[o("div",Z,[o("h2",null,"Conversa - "+x(f.conversa.equipamento.titulo),1),o("div",ee,[o("div",ne,[o("div",{ref_key:"elMensagens",ref:t,class:"mensagens",onScroll:n[0]||(n[0]=(...a)=>V(v)&&V(v)(...a))},[s.mensagensAnteriores?(c(),g("div",se,te)):H("",!0),(c(!0),g($,null,O(s.mensagens,a=>(c(),g("span",{id:"msg-"+a.id,key:a.id,class:P(["mensagem",{autor:a.usuario_id==f.usuario_id}])},x(a.mensagem),11,oe))),128))],544),j(G,{name:"fade-transition",duration:100},{default:S(()=>[s.novasMensagens?(c(),g("button",{key:0,type:"button",class:"novas-mensagens",onClick:C},le)):H("",!0)]),_:1})]),o("form",{class:"mensagens-footer",onSubmit:J(k,["prevent"])},[K(o("textarea",{"onUpdate:modelValue":n[1]||(n[1]=a=>s.mensagem=a),class:"form-control",maxlength:z,rows:"3"},null,512),[[Q,s.mensagem]]),o("div",ce,[ue,o("span",me,x(s.mensagem.length+" / "+z),1)])],40,re)])])]),_:1}))}});export{ve as default};
